<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indeks Bran≈º API</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --text-secondary: #666;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #2a2a3e;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            transition: background 0.3s ease;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2em;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .card h2 {
            color: var(--text-color);
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text-color);
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 1em;
            }

            .sectors-grid {
                grid-template-columns: 1fr !important;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
            }

            .sector-card {
                max-width: 100% !important;
            }

            .sector-card-body {
                grid-template-columns: 1fr !important;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 1em;
            }

            .endpoints {
                grid-template-columns: 1fr !important;
            }

            .trend-chart-container canvas {
                max-width: 100%;
                height: auto;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .card h2 {
                font-size: 1.2em;
            }

            .sector-metric {
                padding: 10px;
            }
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .result {
            margin-top: 20px;
            display: none;
        }

        .result.show {
            display: block;
        }

        .sector-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .sector-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateX(5px);
        }

        .sector-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .sector-card-title {
            flex: 1;
        }

        .sector-card-title h3 {
            color: var(--text-color);
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sector-card-title .pkd-code {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.1em;
        }

        .sector-card-category {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            white-space: nowrap;
        }

        .category-excellent {
            background: #d4edda;
            color: #155724;
        }

        [data-theme="dark"] .category-excellent {
            background: #1e4620;
            color: #90ee90;
        }

        .category-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        [data-theme="dark"] .category-good {
            background: #1a3a3f;
            color: #7dd3fc;
        }

        .category-average {
            background: #fff3cd;
            color: #856404;
        }

        [data-theme="dark"] .category-average {
            background: #3d2e1a;
            color: #fbbf24;
        }

        .category-poor {
            background: #f8d7da;
            color: #721c24;
        }

        [data-theme="dark"] .category-poor {
            background: #3d1a1a;
            color: #f87171;
        }

        .category-very-poor {
            background: #f5c6cb;
            color: #721c24;
        }

        [data-theme="dark"] .category-very-poor {
            background: #4a1a1a;
            color: #ef4444;
        }

        .sector-card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .sector-metric {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .sector-metric:hover {
            transform: scale(1.02);
        }

        .sector-metric-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .sector-metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
        }

        .sector-metric-score {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .score-high {
            background: #d4edda;
            color: #155724;
        }

        [data-theme="dark"] .score-high {
            background: #1e4620;
            color: #90ee90;
        }

        .score-medium {
            background: #fff3cd;
            color: #856404;
        }

        [data-theme="dark"] .score-medium {
            background: #3d2e1a;
            color: #fbbf24;
        }

        .score-low {
            background: #f8d7da;
            color: #721c24;
        }

        [data-theme="dark"] .score-low {
            background: #3d1a1a;
            color: #f87171;
        }

        .sectors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            border-left: 4px solid #c33;
        }

        [data-theme="dark"] .error {
            background: #3d1a1a;
            color: #f87171;
            border-left-color: #f87171;
        }

        .error.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .index-badge {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 25px;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .sector-trend-chart {
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-color);
            border-radius: 8px;
        }

        .trend-chart-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        .trend-chart-container canvas {
            width: 100%;
            height: auto;
            border-radius: 5px;
            display: block;
        }

        .chart-legend {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .chart-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-hover);
            min-width: 300px;
            max-width: 400px;
            border-left: 4px solid var(--primary-color);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            border-left-color: #28a745;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast.info {
            border-left-color: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .section-divider {
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            margin: 40px 0;
            border-radius: 2px;
        }

        .realtime-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>

<body>
    <button class="theme-toggle" id="themeToggle" title="Prze≈ÇƒÖcz motyw">üåì</button>
    <button class="theme-toggle" id="favoritesToggle" title="Poka≈º ulubione" style="right: 80px;"
        onclick="showFavoritesQuick()">‚≠ê</button>

    <div class="container">
        <div class="header">
            <h1>Indeks Bran≈º API</h1>
            <p>System analizy kondycji sektor√≥w polskiej gospodarki</p>
        </div>

        <div class="card">
            <h2>Wyszukaj sektor po kodzie PKD</h2>
            <form id="sectorForm">
                <div class="form-group">
                    <label for="pkdCode">Kod PKD:</label>
                    <select id="pkdCode" required>
                        <option value="">Wybierz kod PKD...</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="sectorFormBtn">Pobierz dane</button>
            </form>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>≈Åadowanie danych...</p>
            </div>
            <div class="result" id="result"></div>
            <div class="error" id="error"></div>
        </div>

        <div class="card">
            <h2>Rankingi</h2>
            <form id="rankingsForm">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label for="topN">Liczba wynik√≥w:</label>
                        <input type="number" id="topN" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label for="sortBy">Sortuj wed≈Çug:</label>
                        <select id="sortBy">
                            <option value="final_index">Indeks ko≈Ñcowy</option>
                            <option value="growth_score">Wzrost</option>
                            <option value="risk_score">Ryzyko</option>
                            <option value="profitability_score">Rentowno≈õƒá</option>
                            <option value="size_score">Wielko≈õƒá</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterCategory">Kategoria:</label>
                        <select id="filterCategory">
                            <option value="">Wszystkie</option>
                            <option value="Bardzo dobra kondycja">Bardzo dobra kondycja</option>
                            <option value="Dobra kondycja">Dobra kondycja</option>
                            <option value="≈örednia kondycja">≈örednia kondycja</option>
                            <option value="S≈Çaba kondycja">S≈Çaba kondycja</option>
                            <option value="Bardzo s≈Çaba kondycja">Bardzo s≈Çaba kondycja</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="minIndex">Min. indeks:</label>
                        <input type="number" id="minIndex" step="0.01" min="0" max="1" placeholder="0.0">
                    </div>
                    <div class="form-group">
                        <label for="maxIndex">Max. indeks:</label>
                        <input type="number" id="maxIndex" step="0.01" min="0" max="1" placeholder="1.0">
                    </div>
                </div>
                <button type="submit" class="btn" id="rankingsFormBtn">Pobierz ranking</button>
            </form>
            <div class="loading" id="loadingRankings">
                <div class="spinner"></div>
                <p>≈Åadowanie rankingu...</p>
            </div>
            <div class="result" id="resultRankings"></div>
            <div class="error" id="errorRankings"></div>
        </div>

        <div class="card">
            <h2>Lista sektor√≥w</h2>
            <form id="sectorsForm">
                <div class="form-group">
                    <label for="limit">Limit wynik√≥w:</label>
                    <input type="number" id="limit" value="20" min="1" max="100">
                </div>
                <div class="form-group">
                    <label for="category">Kategoria (opcjonalnie):</label>
                    <select id="category">
                        <option value="">Wszystkie</option>
                        <option value="Bardzo dobra kondycja">Bardzo dobra kondycja</option>
                        <option value="Dobra kondycja">Dobra kondycja</option>
                        <option value="≈örednia kondycja">≈örednia kondycja</option>
                        <option value="S≈Çaba kondycja">S≈Çaba kondycja</option>
                        <option value="Bardzo s≈Çaba kondycja">Bardzo s≈Çaba kondycja</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="sectorsFormBtn">Pobierz listƒô</button>
            </form>
            <div class="loading" id="loadingSectors">
                <div class="spinner"></div>
                <p>≈Åadowanie listy...</p>
            </div>
            <div class="result" id="resultSectors"></div>
            <div class="error" id="errorSectors"></div>
        </div>

        <div class="section-divider"></div>

        <div class="card">
            <h2>Dane w czasie rzeczywistym <span class="realtime-badge">LIVE</span></h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Pobierz dane statystyczne z Banku Danych Lokalnych (BDL) GUS w czasie rzeczywistym
            </p>
            <form id="realtimeForm">
                <div class="form-group">
                    <label for="realtimeVariableId">ID zmiennej:</label>
                    <input type="text" id="realtimeVariableId" placeholder="np. 3643" required>
                </div>
                <div class="form-group">
                    <label for="realtimeYears">Lata:</label>
                    <input type="text" id="realtimeYears" value="2020,2021,2022,2023,2024,2025"
                        placeholder="np. 2020,2021,2022">
                </div>
                <button type="submit" class="btn" id="realtimeFormBtn">Pobierz dane</button>
            </form>
            <div class="loading" id="loadingRealtime">
                <div class="spinner"></div>
                <p>Pobieranie danych w czasie rzeczywistym...</p>
            </div>
            <div class="result" id="resultRealtime"></div>
            <div class="error" id="errorRealtime"></div>
        </div>

        <div class="section-divider"></div>

        <div class="card">
            <h2>Dashboard</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                PrzeglƒÖd og√≥lnej kondycji wszystkich sektor√≥w
            </p>
            <button type="button" class="btn" id="dashboardBtn" onclick="loadDashboard()">Za≈Çaduj dashboard</button>
            <div class="loading" id="loadingDashboard" style="display: none;">
                <div class="spinner"></div>
                <p>≈Åadowanie dashboardu...</p>
            </div>
            <div class="result" id="resultDashboard"></div>
            <div class="error" id="errorDashboard"></div>
        </div>

        <div class="card">
            <h2>Zaawansowane wyszukiwanie</h2>
            <form id="advancedSearchForm">
                <div class="form-group">
                    <label for="searchQuery">Szukaj (nazwa lub kod PKD):</label>
                    <input type="text" id="searchQuery" placeholder="np. IT, 62, us≈Çugi">
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label for="minIndex">Min. indeks:</label>
                        <input type="number" id="minIndex" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="maxIndex">Max. indeks:</label>
                        <input type="number" id="maxIndex" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="minGrowth">Min. wzrost:</label>
                        <input type="number" id="minGrowth" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="maxGrowth">Max. wzrost:</label>
                        <input type="number" id="maxGrowth" step="0.01" min="0" max="1">
                    </div>
                </div>
                <div class="form-group">
                    <label for="searchCategories">Kategorie (oddzielone przecinkami):</label>
                    <input type="text" id="searchCategories" placeholder="np. Dobra kondycja, ≈örednia kondycja">
                </div>
                <button type="submit" class="btn" id="advancedSearchBtn">Szukaj</button>
            </form>
            <div class="loading" id="loadingAdvancedSearch" style="display: none;">
                <div class="spinner"></div>
                <p>Wyszukiwanie...</p>
            </div>
            <div class="result" id="resultAdvancedSearch"></div>
            <div class="error" id="errorAdvancedSearch"></div>
        </div>

        <div class="card">
            <h2>Por√≥wnaj sektory</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Por√≥wnaj do 3 sektor√≥w jednocze≈õnie
            </p>
            <form id="compareForm">
                <div class="form-group">
                    <label for="comparePkd1">Sektor 1 (Kod PKD):</label>
                    <select id="comparePkd1" required>
                        <option value="">Wybierz sektor...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="comparePkd2">Sektor 2 (Kod PKD, opcjonalnie):</label>
                    <select id="comparePkd2">
                        <option value="">Wybierz sektor...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="comparePkd3">Sektor 3 (Kod PKD, opcjonalnie):</label>
                    <select id="comparePkd3">
                        <option value="">Wybierz sektor...</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="compareBtn">Por√≥wnaj</button>
            </form>
            <div class="loading" id="loadingCompare" style="display: none;">
                <div class="spinner"></div>
                <p>Por√≥wnywanie sektor√≥w...</p>
            </div>
            <div class="result" id="resultCompare"></div>
            <div class="error" id="errorCompare"></div>
        </div>

        <div class="card">
            <h2>Prognoza i trendy</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Sprawd≈∫ prognozƒô na nastƒôpny rok i trendy dla sektora
            </p>
            <form id="predictionForm">
                <div class="form-group">
                    <label for="predictionPkd">Kod PKD:</label>
                    <select id="predictionPkd" required>
                        <option value="">Wybierz kod PKD...</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="predictionBtn">Pobierz prognozƒô</button>
            </form>
            <div class="loading" id="loadingPrediction" style="display: none;">
                <div class="spinner"></div>
                <p>Obliczanie prognozy...</p>
            </div>
            <div class="result" id="resultPrediction"></div>
            <div class="error" id="errorPrediction"></div>
        </div>

        <div class="card">
            <h2>Rekomendacje</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Znajd≈∫ podobne sektory do wybranego
            </p>
            <form id="recommendationsForm">
                <div class="form-group">
                    <label for="recommendationsPkd">Kod PKD:</label>
                    <select id="recommendationsPkd" required>
                        <option value="">Wybierz kod PKD...</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="recommendationsBtn">Znajd≈∫ podobne</button>
            </form>
            <div class="loading" id="loadingRecommendations" style="display: none;">
                <div class="spinner"></div>
                <p>Szukanie podobnych sektor√≥w...</p>
            </div>
            <div class="result" id="resultRecommendations"></div>
            <div class="error" id="errorRecommendations"></div>
        </div>

        <div class="card">
            <h2>Por√≥wnanie okres√≥w</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Por√≥wnaj dane z r√≥≈ºnych okres√≥w czasowych
            </p>
            <form id="periodCompareForm">
                <div class="form-group">
                    <label for="periodPkd">Kod PKD:</label>
                    <select id="periodPkd" required>
                        <option value="">Wybierz kod PKD...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="period1Start">Okres 1 - od roku:</label>
                        <input type="number" id="period1Start" min="2000" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="period1End">Okres 1 - do roku:</label>
                        <input type="number" id="period1End" min="2000" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="period2Start">Okres 2 - od roku:</label>
                        <input type="number" id="period2Start" min="2000" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="period2End">Okres 2 - do roku:</label>
                        <input type="number" id="period2End" min="2000" max="2030" required>
                    </div>
                </div>
                <button type="submit" class="btn" id="periodCompareBtn">Por√≥wnaj okresy</button>
            </form>
            <div class="loading" id="loadingPeriodCompare" style="display: none;">
                <div class="spinner"></div>
                <p>Por√≥wnywanie okres√≥w...</p>
            </div>
            <div class="result" id="resultPeriodCompare"></div>
            <div class="error" id="errorPeriodCompare"></div>
        </div>

        <div class="card">
            <h2>Analiza korelacji</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Analiza korelacji miƒôdzy wska≈∫nikami
            </p>
            <button type="button" class="btn" id="correlationsBtn" onclick="loadCorrelations()">Za≈Çaduj analizƒô</button>
            <div class="loading" id="loadingCorrelations" style="display: none;">
                <div class="spinner"></div>
                <p>Obliczanie korelacji...</p>
            </div>
            <div class="result" id="resultCorrelations"></div>
            <div class="error" id="errorCorrelations"></div>
        </div>

        <div class="card">
            <h2>Ulubione sektory</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                ZarzƒÖdzaj ulubionymi sektorami
            </p>
            <div id="favoritesList" style="margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="favoritePkd">Dodaj do ulubionych:</label>
                <select id="favoritePkd">
                    <option value="">Wybierz kod PKD...</option>
                </select>
            </div>
            <button type="button" class="btn" id="addFavoriteBtn" onclick="addFavorite()">Dodaj do ulubionych</button>
        </div>

        <div class="card">
            <h2>Notatki</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Dodaj notatki do sektor√≥w
            </p>
            <div class="form-group">
                <label for="notePkd">Kod PKD:</label>
                <select id="notePkd">
                    <option value="">Wybierz kod PKD...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="noteText">Notatka:</label>
                <textarea id="noteText" rows="4" placeholder="Wpisz notatkƒô..."></textarea>
            </div>
            <button type="button" class="btn" id="saveNoteBtn" onclick="saveNote()">Zapisz notatkƒô</button>
            <div id="notesList" style="margin-top: 20px;"></div>
        </div>

        <div class="section-divider"></div>

        <div class="card">
            <h2>Dostƒôpne endpointy API</h2>
            <div class="endpoints"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                <div class="endpoint-card"
                    style="background: var(--bg-color); padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 8px;">GET /health</h4>
                    <p style="color: var(--text-secondary);">Sprawdzenie stanu serwisu</p>
                    <code
                        style="background: var(--card-bg); padding: 5px 8px; border-radius: 3px; font-size: 0.9em; display: block; margin-top: 8px;">/health</code>
                </div>
                <div class="endpoint-card"
                    style="background: var(--bg-color); padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 8px;">GET /sectors</h4>
                    <p style="color: var(--text-secondary);">Lista wszystkich sektor√≥w</p>
                    <code
                        style="background: var(--card-bg); padding: 5px 8px; border-radius: 3px; font-size: 0.9em; display: block; margin-top: 8px;">/sectors?limit=10</code>
                </div>
                <div class="endpoint-card"
                    style="background: var(--bg-color); padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 8px;">GET /sector/{pkd}</h4>
                    <p style="color: var(--text-secondary);">Szczeg√≥≈Çy sektora</p>
                    <code
                        style="background: var(--card-bg); padding: 5px 8px; border-radius: 3px; font-size: 0.9em; display: block; margin-top: 8px;">/sector/62</code>
                </div>
                <div class="endpoint-card"
                    style="background: var(--bg-color); padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 8px;">GET /rankings</h4>
                    <p style="color: var(--text-secondary);">Ranking sektor√≥w</p>
                    <code
                        style="background: var(--card-bg); padding: 5px 8px; border-radius: 3px; font-size: 0.9em; display: block; margin-top: 8px;">/rankings?top_n=10</code>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <a href="/docs" target="_blank" class="btn"
                    style="text-decoration: none; display: inline-block; text-align: center;">üìö Dokumentacja
                    Swagger</a>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        let availablePkdCodes = [];
        let loadingStates = {
            sector: false,
            rankings: false,
            sectors: false,
            realtime: false
        };

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <span style="font-size: 1.2em;">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function setButtonLoading(buttonId, loading) {
            const btn = document.getElementById(buttonId);
            if (!btn) return;

            if (loading) {
                btn.disabled = true;
                btn.classList.add('btn-loading');
                btn.style.color = 'transparent';
            } else {
                btn.disabled = false;
                btn.classList.remove('btn-loading');
                btn.style.color = '';
            }
        }

        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeToggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            showToast(`Prze≈ÇƒÖczono na motyw ${newTheme === 'dark' ? 'ciemny' : 'jasny'}`, 'success');
        });

        async function loadAvailablePkdCodes() {
            try {
                const data = await fetchData('/available-pkd');
                availablePkdCodes = data.sectors || [];

                const select = document.getElementById('pkdCode');
                if (select) {
                    select.innerHTML = '<option value="">Wybierz kod PKD...</option>';

                    availablePkdCodes.forEach(sector => {
                        const option = document.createElement('option');
                        option.value = sector.pkd_code;
                        option.textContent = `${sector.pkd_code} - ${sector.branch_name || 'Nieznana bran≈ºa'}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania dostƒôpnych kod√≥w PKD:', error);
            }
        }

        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        function getCategoryClass(category) {
            const classes = {
                'Bardzo dobra kondycja': 'category-excellent',
                'Dobra kondycja': 'category-good',
                '≈örednia kondycja': 'category-average',
                'S≈Çaba kondycja': 'category-poor',
                'Bardzo s≈Çaba kondycja': 'category-very-poor'
            };
            return classes[category] || 'category-average';
        }

        function getScoreClass(score) {
            if (score >= 0.7) return 'score-high';
            if (score >= 0.4) return 'score-medium';
            return 'score-low';
        }

        function translateFieldName(key) {
            const translations = {
                'rank': 'Ranking',
                'size_score': 'Wielko≈õƒá',
                'growth_score': 'Rozw√≥j',
                'profitability_score': 'Rentowno≈õƒá',
                'debt_score': 'Zad≈Çu≈ºenie',
                'risk_score': 'Ryzyko',
                'revenue_growth_yoy': 'Wzrost przychod√≥w (YoY)',
                'profit_growth_yoy': 'Wzrost zysku (YoY)',
                'profit_margin': 'Mar≈ºa zysku',
                'debt_to_assets': 'Zad≈Çu≈ºenie do aktyw√≥w',
                'bankruptcy_rate': 'Wska≈∫nik upad≈Ço≈õci',
                'num_companies': 'Liczba przedsiƒôbiorstw',
                'revenue': 'Przychody',
                'profit': 'Zysk',
                'assets': 'Aktywa',
                'debt': 'D≈Çug',
                'bankruptcies': 'Upad≈Ço≈õci',
                'year': 'Rok',
                'final_index': 'Indeks ko≈Ñcowy',
                'pkd_code': 'Kod PKD',
                'branch_name': 'Nazwa bran≈ºy',
                'category': 'Kategoria'
            };
            return translations[key] || key;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            if (typeof num === 'number') {
                const absNum = Math.abs(num);
                const sign = num < 0 ? '-' : '';
                if (absNum >= 1000000) return sign + (absNum / 1000000).toFixed(2) + 'M';
                if (absNum >= 1000) return sign + (absNum / 1000).toFixed(2) + 'K';
                return sign + absNum.toFixed(2);
            }
            return num;
        }

        function formatPercent(num, baseValue = null) {
            if (num === null || num === undefined) return 'N/A';
            const absNum = Math.abs(num);
            const sign = num < 0 ? '-' : '';
            const percent = sign + (absNum * 100).toFixed(2) + '%';
            if (baseValue !== null && baseValue !== undefined && typeof baseValue === 'number' && baseValue !== 0) {
                const moneyValue = baseValue * num;
                const formattedMoney = formatNumber(moneyValue);
                return `${percent} (‚âà ${formattedMoney} z≈Ç)`;
            }
            return percent;
        }

        function createComparisonTable(sectors) {
            if (!sectors || sectors.length === 0) return '<p>Brak danych do por√≥wnania</p>';

            const metrics = [
                { key: 'final_index', label: 'Indeks ko≈Ñcowy', format: (v) => (v || 0).toFixed(3) },
                { key: 'size_score', label: 'Wielko≈õƒá', format: (v) => (v || 0).toFixed(3) },
                { key: 'growth_score', label: 'Rozw√≥j', format: (v) => (v || 0).toFixed(3) },
                { key: 'profitability_score', label: 'Rentowno≈õƒá', format: (v) => (v || 0).toFixed(3) },
                { key: 'debt_score', label: 'Zad≈Çu≈ºenie', format: (v) => (v || 0).toFixed(3) },
                { key: 'risk_score', label: 'Ryzyko', format: (v) => (v || 0).toFixed(3) },
                { key: 'revenue_growth_yoy', label: 'Wzrost przychod√≥w (YoY)', format: (v) => formatPercent(v || 0) },
                { key: 'profit_margin', label: 'Mar≈ºa zysku', format: (v) => formatPercent(v || 0) },
                { key: 'num_companies', label: 'Liczba przedsiƒôbiorstw', format: (v) => formatNumber(v || 0) }
            ];

            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];

            let table = `
                <div style="overflow-x: auto; border-radius: 10px; border: 1px solid var(--border-color);">
                    <table style="width: 100%; border-collapse: collapse; background: var(--card-bg);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
                                <th style="padding: 15px; text-align: left; font-weight: 600; position: sticky; left: 0; background: inherit; z-index: 10;">Metryka</th>
            `;

            sectors.forEach((sector, idx) => {
                const color = colors[idx % colors.length];
                table += `
                    <th style="padding: 15px; text-align: center; font-weight: 600; background: ${color}20; border-left: 3px solid ${color};">
                        <div style="font-size: 0.9em; font-weight: 700; color: ${color};">${sector.pkd_code}</div>
                        <div style="font-size: 0.75em; opacity: 0.9; margin-top: 3px;">${sector.branch_name || 'N/A'}</div>
                    </th>
                `;
            });

            table += `</tr></thead><tbody>`;

            metrics.forEach((metric, mIdx) => {
                const rowClass = mIdx % 2 === 0 ? 'background: var(--card-bg);' : 'background: rgba(0,0,0,0.02);';
                table += `<tr style="${rowClass}">`;
                table += `<td style="padding: 12px 15px; font-weight: 600; position: sticky; left: 0; background: inherit; border-right: 2px solid var(--border-color);">${metric.label}</td>`;

                const values = sectors.map(s => s[metric.key]);
                const maxVal = Math.max(...values.filter(v => v != null && !isNaN(v)));
                const minVal = Math.min(...values.filter(v => v != null && !isNaN(v)));

                sectors.forEach((sector, idx) => {
                    const value = sector[metric.key];
                    const formatted = metric.format(value);
                    const isMax = value === maxVal && value != null && !isNaN(value);
                    const isMin = value === minVal && value != null && !isNaN(value);

                    let cellStyle = 'padding: 12px 15px; text-align: center;';
                    if (isMax) cellStyle += ' background: #d4edda; font-weight: 600; color: #155724;';
                    else if (isMin) cellStyle += ' background: #f8d7da; font-weight: 600; color: #721c24;';

                    table += `<td style="${cellStyle}">${formatted}</td>`;
                });
                table += `</tr>`;
            });

            table += `</tbody></table></div>`;
            return table;
        }

        function createComparisonCharts(sectors) {
            if (!sectors || sectors.length === 0) return '<p>Brak danych do wykres√≥w</p>';

            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];
            const chartId = 'compareChart_' + Date.now();

            const metrics = [
                { key: 'final_index', label: 'Indeks ko≈Ñcowy' },
                { key: 'growth_score', label: 'Rozw√≥j' },
                { key: 'profitability_score', label: 'Rentowno≈õƒá' },
                { key: 'risk_score', label: 'Ryzyko' }
            ];

            let chartHtml = `
                <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                    <canvas id="${chartId}" width="800" height="400" style="max-width: 100%; height: auto; border-radius: 8px;"></canvas>
                </div>
            `;

            setTimeout(() => {
                const canvas = document.getElementById(chartId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;

                const padding = 70;
                const chartWidth = canvas.width - padding * 2;
                const chartHeight = canvas.height - padding * 2;

                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card-bg') || '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = chartWidth / (metrics.length * sectors.length + metrics.length * 0.3);
                const groupWidth = barWidth * sectors.length * 1.3;
                const maxValue = Math.max(...metrics.map(m => Math.max(...sectors.map(s => (s[m.key] || 0) * 1.1))));

                metrics.forEach((metric, mIdx) => {
                    const groupX = padding + mIdx * (groupWidth + 30);

                    sectors.forEach((sector, sIdx) => {
                        const value = sector[metric.key] || 0;
                        const barHeight = maxValue > 0 ? (value / maxValue) * chartHeight : 0;
                        const barX = groupX + sIdx * barWidth * 1.2;
                        const barY = padding + chartHeight - barHeight;

                        const gradient = ctx.createLinearGradient(barX, barY, barX, barY + barHeight);
                        gradient.addColorStop(0, colors[sIdx % colors.length]);
                        gradient.addColorStop(1, colors[sIdx % colors.length] + '80');
                        ctx.fillStyle = gradient;
                        ctx.fillRect(barX, barY, barWidth * 0.9, barHeight);

                        ctx.strokeStyle = colors[sIdx % colors.length];
                        ctx.lineWidth = 2;
                        ctx.strokeRect(barX, barY, barWidth * 0.9, barHeight);

                        if (barHeight > 20) {
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color') || '#333';
                            ctx.font = 'bold 11px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(value.toFixed(3), barX + barWidth * 0.45, barY - 5);
                        }
                    });

                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color') || '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(metric.label, groupX + groupWidth / 2, canvas.height - padding + 25);
                });

                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                for (let i = 0; i <= 5; i++) {
                    const value = (maxValue / 5) * i;
                    const y = padding + chartHeight - (i / 5) * chartHeight;
                    ctx.fillText(value.toFixed(2), padding - 10, y + 4);
                    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color') || '#e0e0e0';
                    ctx.lineWidth = 0.5;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(canvas.width - padding, y);
                    ctx.stroke();
                }

                const legendY = 20;
                sectors.forEach((sector, idx) => {
                    const legendX = padding + idx * 180;
                    ctx.fillStyle = colors[idx % colors.length];
                    ctx.fillRect(legendX, legendY, 15, 15);
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color') || '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    const label = `${sector.pkd_code} - ${(sector.branch_name || 'N/A').substring(0, 25)}`;
                    ctx.fillText(label, legendX + 20, legendY + 12);
                });
            }, 200);

            return chartHtml;
        }

        function renderIndexHistoryChart(pkdCode, historyData) {
            const chartId = `indexHistoryChart_${pkdCode}`;
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            if (!canvas) {
                const container = document.getElementById(`indexHistoryChart_${pkdCode}`);
                if (container) {
                    const newCanvas = document.createElement('canvas');
                    newCanvas.id = chartId;
                    newCanvas.width = 800;
                    newCanvas.height = 300;
                    newCanvas.style.maxWidth = '100%';
                    newCanvas.style.height = 'auto';
                    container.appendChild(newCanvas);
                    return renderIndexHistoryChart(pkdCode, historyData);
                }
            }

            canvas.width = 800;
            canvas.height = 300;

            const padding = 50;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card-bg') || '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!historyData || historyData.length === 0) return;

            const years = historyData.map(d => parseInt(d.year) || 0).filter(y => y > 0).sort((a, b) => a - b);
            const revenues = years.map(y => {
                const data = historyData.find(d => parseInt(d.year) === y);
                return data ? (data.revenue || 0) : 0;
            });

            if (years.length === 0) return;

            const maxRevenue = Math.max(...revenues, 1);
            const minRevenue = Math.min(...revenues);
            const range = maxRevenue - minRevenue || 1;

            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color') || '#e0e0e0';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }

            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();

            years.forEach((year, i) => {
                const x = padding + (i / (years.length - 1)) * chartWidth;
                const normalizedValue = (revenues[i] - minRevenue) / range;
                const y = padding + chartHeight - (normalizedValue * chartHeight);

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            ctx.fillStyle = '#667eea';
            years.forEach((year, i) => {
                const x = padding + (i / (years.length - 1)) * chartWidth;
                const normalizedValue = (revenues[i] - minRevenue) / range;
                const y = padding + chartHeight - (normalizedValue * chartHeight);

                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();

                if (i % Math.ceil(years.length / 5) === 0 || i === years.length - 1) {
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(String(year), x, canvas.height - padding + 15);
                }
            });

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = minRevenue + (range / 5) * i;
                const y = padding + chartHeight - (i / 5) * chartHeight;
                ctx.fillText(formatNumber(value), padding - 10, y + 4);
            }
        }

        function createTrendChart(historyData, pkdCode) {
            if (!historyData || historyData.length === 0) {
                return '<div class="chart-placeholder">Brak danych historycznych</div>';
            }

            const uniqueYears = [...new Set(historyData.map(d => parseInt(d.year) || 0).filter(y => y > 0))].sort((a, b) => a - b);
            if (uniqueYears.length === 0) {
                return '<div class="chart-placeholder">Brak poprawnych danych</div>';
            }

            const revenues = uniqueYears.map(year => {
                const data = historyData.find(d => parseInt(d.year) === year);
                return data ? (parseFloat(data.revenue) || 0) : 0;
            });
            const profits = uniqueYears.map(year => {
                const data = historyData.find(d => parseInt(d.year) === year);
                return data ? (parseFloat(data.profit) || 0) : 0;
            });

            const years = uniqueYears;

            const canvasId = `chart-${pkdCode}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const chartHtml = `
                <div class="trend-chart-container">
                    <canvas id="${canvasId}" width="500" height="250"></canvas>
                    <div class="chart-legend">
                        <span style="color:#667eea">‚óè</span> Przychody 
                        <span style="color:#28a745">‚óè</span> Zysk
                    </div>
                </div>
            `;

            setTimeout(() => {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                if (!ctx) return;

                const width = canvas.width;
                const height = canvas.height;
                const padding = 50;
                const chartWidth = width - 2 * padding;
                const chartHeight = height - 2 * padding;

                ctx.clearRect(0, 0, width, height);
                const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-color') || '#f8f9fa';
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, width, height);

                const maxRevenue = Math.max(...revenues, 1);
                const maxProfit = Math.max(...profits, 1);
                const maxValue = Math.max(maxRevenue, maxProfit);

                const step = chartWidth / Math.max(years.length - 1, 1);
                const yearSpacing = Math.max(1, Math.floor(years.length / 10));

                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                years.forEach((year, i) => {
                    const x = padding + i * step;
                    const y = height - padding - (revenues[i] / maxValue) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                ctx.fillStyle = '#667eea';
                years.forEach((year, i) => {
                    const x = padding + i * step;
                    const y = height - padding - (revenues[i] / maxValue) * chartHeight;
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });

                ctx.strokeStyle = '#28a745';
                ctx.beginPath();
                years.forEach((year, i) => {
                    const x = padding + i * step;
                    const y = height - padding - (profits[i] / maxValue) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                ctx.fillStyle = '#28a745';
                years.forEach((year, i) => {
                    const x = padding + i * step;
                    const y = height - padding - (profits[i] / maxValue) * chartHeight;
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });

                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';

                years.forEach((year, i) => {
                    if (i % yearSpacing === 0 || i === years.length - 1) {
                        const x = padding + i * step;
                        const yearStr = String(year);
                        const textWidth = ctx.measureText(yearStr).width;
                        if (i > 0) {
                            const prevX = padding + (i - 1) * step;
                            if (x - prevX < textWidth + 10) return;
                        }
                        ctx.fillText(yearStr, x, height - padding + 5);
                    }
                });
            }, 150);

            return chartHtml;
        }

        async function createSectorCard(sector, showChart = false) {
            const card = document.createElement('div');
            card.className = 'sector-card';

            const categoryClass = getCategoryClass(sector.category || '≈örednia kondycja');

            let historyChart = '';
            let latestHistory = null;

            let historyData = null;
            try {
                historyData = await fetchData(`/sector/${sector.pkd_code}/history`);
                if (historyData && Array.isArray(historyData) && historyData.length > 0) {
                    latestHistory = historyData[historyData.length - 1];
                    if (showChart) {
                        historyChart = createTrendChart(historyData, sector.pkd_code);
                    }
                } else {
                    if (showChart) {
                        historyChart = '<div class="chart-placeholder">Brak danych historycznych</div>';
                    }
                }
            } catch (error) {
                if (showChart) {
                    historyChart = `<div class="chart-placeholder">B≈ÇƒÖd: ${error.message}</div>`;
                }
            }

            if (showChart && historyData) {
                setTimeout(() => {
                    renderIndexHistoryChart(sector.pkd_code, historyData);
                }, 200);
            }

            const revenue = latestHistory ? (latestHistory.revenue || 0) : (sector.num_companies * 1000000 || 0);
            const profit = latestHistory ? (latestHistory.profit || 0) : (revenue * (sector.profit_margin || 0.15));
            const assets = latestHistory ? (latestHistory.assets || 0) : (revenue * 2 || 0);
            const debt = latestHistory ? (latestHistory.debt || 0) : (assets * (sector.debt_to_assets || 0.3));

            card.innerHTML = `
                <div class="sector-card-header">
                    <div class="sector-card-title">
                        <div class="index-badge">Indeks: ${(sector.final_index || 0).toFixed(3)}</div>
                        <h3>${sector.branch_name || 'Nieznana bran≈ºa'}</h3>
                        <div class="pkd-code">Kod PKD: ${sector.pkd_code}</div>
                    </div>
                    <div class="sector-card-category ${categoryClass}">
                        ${sector.category || 'Brak kategorii'}
                    </div>
                </div>
                ${showChart ? `<div class="sector-trend-chart">${historyChart}</div>` : ''}
                ${showChart ? `<div style="margin: 20px 0; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 10px; color: var(--text-color);">Historia zmian przychod√≥w</h4>
                    <canvas id="indexHistoryChart_${sector.pkd_code}" width="800" height="300" style="max-width: 100%; height: auto; border-radius: 8px;"></canvas>
                </div>` : ''}
                <div class="sector-card-body">
                    <div class="sector-metric">
                        <div class="sector-metric-label">Poziom przychod√≥w w z≈Ç</div>
                        <div class="sector-metric-value">
                            ${latestHistory && latestHistory.revenue ? formatNumber(latestHistory.revenue) + ' z≈Ç' : 'N/A'}
                        </div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Poziom zysku dzielony przez przychody</div>
                        <div class="sector-metric-value">
                            ${formatPercent(sector.profit_margin || 0, revenue)}
                        </div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">D≈Çug netto</div>
                        <div class="sector-metric-value">
                            ${latestHistory && latestHistory.debt ? formatNumber(latestHistory.debt) + ' z≈Ç' : 'N/A'}
                        </div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Ryzyko</div>
                        <div class="sector-metric-value">
                            ${(sector.risk_score || 0).toFixed(3)}
                            <span class="sector-metric-score ${getScoreClass(sector.risk_score || 0)}">
                                ${formatPercent(sector.risk_score || 0)}
                            </span>
                        </div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Wzrost przychod√≥w (YoY)</div>
                        <div class="sector-metric-value">${formatPercent(sector.revenue_growth_yoy, revenue)}</div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Wzrost zysku (YoY)</div>
                        <div class="sector-metric-value">${formatPercent(sector.profit_growth_yoy, profit)}</div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Mar≈ºa zysku</div>
                        <div class="sector-metric-value">${formatPercent(sector.profit_margin, revenue)}</div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Zad≈Çu≈ºenie do aktyw√≥w</div>
                        <div class="sector-metric-value">${formatPercent(sector.debt_to_assets, assets)}</div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Wska≈∫nik upad≈Ço≈õci</div>
                        <div class="sector-metric-value">${formatPercent(sector.bankruptcy_rate, sector.num_companies || 0)} <span style="font-size: 0.85em; color: var(--text-secondary);">(‚âà ${Math.round((sector.bankruptcy_rate || 0) * (sector.num_companies || 0))} firm)</span></div>
                    </div>
                    <div class="sector-metric">
                        <div class="sector-metric-label">Liczba przedsiƒôbiorstw</div>
                        <div class="sector-metric-value">${formatNumber(sector.num_companies)}</div>
                    </div>
                    ${sector.rank ? `<div class="sector-metric">
                        <div class="sector-metric-label">Ranking</div>
                        <div class="sector-metric-value">#${sector.rank}</div>
                    </div>` : ''}
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="exportSectorData('${sector.pkd_code}', 'csv')" class="btn" style="flex: 1; min-width: 100px; padding: 8px 15px; font-size: 0.9em;">CSV</button>
                    <button onclick="exportSectorData('${sector.pkd_code}', 'excel')" class="btn" style="flex: 1; min-width: 100px; padding: 8px 15px; font-size: 0.9em;">Excel</button>
                    <button onclick="exportSectorData('${sector.pkd_code}', 'pdf')" class="btn" style="flex: 1; min-width: 100px; padding: 8px 15px; font-size: 0.9em;">PDF</button>
                </div>
            `;

            return card;
        }

        async function showSectorCard(containerId, sector) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const card = await createSectorCard(sector, true);
            container.appendChild(card);
            container.classList.add('show');
        }

        async function showSectorsGrid(containerId, sectors) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!sectors || sectors.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Brak wynik√≥w</p>';
                container.classList.add('show');
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'sectors-grid';

            for (const sector of sectors) {
                const card = await createSectorCard(sector);
                grid.appendChild(card);
            }

            container.appendChild(grid);
            container.classList.add('show');
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.add('show');
            showToast(message, 'error');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.remove('show');
        }

        function showLoading(elementId) {
            document.getElementById(elementId).classList.add('show');
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAvailablePkdCodes();
        });

        document.getElementById('sectorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (loadingStates.sector) {
                showToast('Proszƒô poczekaƒá na zako≈Ñczenie bie≈ºƒÖcego ≈ºƒÖdania', 'warning');
                return;
            }

            const pkdCode = document.getElementById('pkdCode').value.trim();
            if (!pkdCode) {
                showError('error', 'Proszƒô wybraƒá kod PKD');
                return;
            }

            loadingStates.sector = true;
            setButtonLoading('sectorFormBtn', true);
            const resultEl = document.getElementById('result');
            const errorEl = document.getElementById('error');

            resultEl.classList.remove('show');
            hideError('error');
            showLoading('loading');
            showToast('Pobieranie danych sektora...', 'info');

            try {
                const data = await fetchData(`/sector/${pkdCode}`);
                hideLoading('loading');
                await showSectorCard('result', data);
                showToast('Dane sektora za≈Çadowane pomy≈õlnie', 'success');
            } catch (error) {
                hideLoading('loading');
                showError('error', `B≈ÇƒÖd: ${error.message}`);
            } finally {
                loadingStates.sector = false;
                setButtonLoading('sectorFormBtn', false);
            }
        });

        document.getElementById('rankingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (loadingStates.rankings) {
                showToast('Proszƒô poczekaƒá na zako≈Ñczenie bie≈ºƒÖcego ≈ºƒÖdania', 'warning');
                return;
            }

            loadingStates.rankings = true;
            setButtonLoading('rankingsFormBtn', true);
            const topN = document.getElementById('topN').value;
            const sortBy = document.getElementById('sortBy').value;
            const category = document.getElementById('filterCategory').value;
            const minIndex = document.getElementById('minIndex').value;
            const maxIndex = document.getElementById('maxIndex').value;
            const resultEl = document.getElementById('resultRankings');
            const errorEl = document.getElementById('errorRankings');

            resultEl.classList.remove('show');
            hideError('errorRankings');
            showLoading('loadingRankings');
            showToast('Pobieranie rankingu...', 'info');

            try {
                let data = await fetchData(`/rankings?top_n=200&sort_by=${sortBy}`);

                if (!Array.isArray(data)) {
                    throw new Error('Nieprawid≈Çowy format danych');
                }

                if (category && category !== '' && category !== 'Wszystkie') {
                    data = data.filter(s => s && s.category === category);
                }
                if (minIndex && minIndex !== '' && !isNaN(parseFloat(minIndex))) {
                    const minVal = parseFloat(minIndex);
                    data = data.filter(s => {
                        if (!s) return false;
                        const idx = parseFloat(s.final_index);
                        return !isNaN(idx) && idx >= minVal;
                    });
                }
                if (maxIndex && maxIndex !== '' && !isNaN(parseFloat(maxIndex))) {
                    const maxVal = parseFloat(maxIndex);
                    data = data.filter(s => {
                        if (!s) return false;
                        const idx = parseFloat(s.final_index);
                        return !isNaN(idx) && idx <= maxVal;
                    });
                }

                const limit = parseInt(topN) || 10;
                if (limit > 0) {
                    data = data.slice(0, limit);
                }

                hideLoading('loadingRankings');
                await showSectorsGrid('resultRankings', data);
                showToast(`Znaleziono ${data.length} sektor√≥w`, 'success');
            } catch (error) {
                hideLoading('loadingRankings');
                let errorMessage = 'Nieznany b≈ÇƒÖd';
                if (error) {
                    if (typeof error === 'string') {
                        errorMessage = error;
                    } else if (error.message) {
                        errorMessage = error.message;
                    } else if (error.detail) {
                        errorMessage = error.detail;
                    } else if (typeof error === 'object') {
                        try {
                            errorMessage = JSON.stringify(error);
                        } catch (e) {
                            errorMessage = 'B≈ÇƒÖd przetwarzania danych';
                        }
                    }
                }
                showError('errorRankings', `B≈ÇƒÖd: ${errorMessage}`);
            } finally {
                loadingStates.rankings = false;
                setButtonLoading('rankingsFormBtn', false);
            }
        });

        document.getElementById('sectorsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (loadingStates.sectors) {
                showToast('Proszƒô poczekaƒá na zako≈Ñczenie bie≈ºƒÖcego ≈ºƒÖdania', 'warning');
                return;
            }

            loadingStates.sectors = true;
            setButtonLoading('sectorsFormBtn', true);
            const limit = document.getElementById('limit').value;
            const category = document.getElementById('category').value;
            const resultEl = document.getElementById('resultSectors');
            const errorEl = document.getElementById('errorSectors');

            resultEl.classList.remove('show');
            hideError('errorSectors');
            showLoading('loadingSectors');
            showToast('Pobieranie listy sektor√≥w...', 'info');

            try {
                let url = `/sectors?limit=${limit}`;
                if (category && category.trim()) {
                    url += `&category=${encodeURIComponent(category.trim())}`;
                }
                const data = await fetchData(url);
                hideLoading('loadingSectors');
                await showSectorsGrid('resultSectors', data);
                showToast(`Znaleziono ${data.length} sektor√≥w`, 'success');
            } catch (error) {
                hideLoading('loadingSectors');
                showError('errorSectors', `B≈ÇƒÖd: ${error.message}`);
            } finally {
                loadingStates.sectors = false;
                setButtonLoading('sectorsFormBtn', false);
            }
        });


        function extractValue(obj) {
            if (obj === null || obj === undefined) return null;
            if (typeof obj === 'number') return obj;
            if (typeof obj === 'string') {
                const num = parseFloat(obj);
                return isNaN(num) ? obj : num;
            }
            if (typeof obj === 'object') {
                return obj.val || obj.value || obj.Value || obj.id || null;
            }
            return obj;
        }

        function formatBDLData(data, type) {
            if (!data) return '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>';

            if (type === 'metrics' || type === 'realtime') {
                const metrics = data.metrics || {};
                if (Object.keys(metrics).length === 0) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>';
                }

                return Object.entries(metrics).map(([key, metric]) => {
                    const value = metric.value || metric || 0;
                    const count = metric.count || 0;
                    const formattedValue = typeof value === 'number' ? value.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : value;

                    return `
                        <div class="sector-metric">
                            <div class="sector-metric-label">${translateFieldName(key)}</div>
                            <div class="sector-metric-value">${formattedValue}</div>
                            ${count > 0 ? `<div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 3px;">Liczba rekord√≥w: ${count}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } else if (type === 'subjects') {
                const subjects = Array.isArray(data) ? data : (data.subjects || []);
                if (subjects.length === 0) return '<p style="text-align: center; color: var(--text-secondary);">Nie znaleziono temat√≥w</p>';

                return subjects.map(subject => {
                    const name = subject.name || subject.Name || 'Brak nazwy';
                    return `
                        <div class="sector-metric">
                            <div class="sector-metric-label">${name}</div>
                        </div>
                    `;
                }).join('');
            } else if (type === 'variables') {
                const variables = Array.isArray(data) ? data : (data.variables || []);
                if (variables.length === 0) return '<p style="text-align: center; color: var(--text-secondary);">Nie znaleziono zmiennych</p>';

                return variables.map(variable => {
                    const name = variable.name || variable.Name || 'Brak nazwy';
                    const unit = variable.measureUnit || variable.MeasureUnit || '';
                    return `
                        <div class="sector-metric">
                            <div class="sector-metric-label">${name}</div>
                            ${unit ? `<div style="font-size: 0.85em; color: var(--text-secondary);">${unit}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } else if (type === 'data') {
                const results = data.results || data.data || data;
                if (!results || (Array.isArray(results) && results.length === 0)) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>';
                }

                const dataArray = Array.isArray(results) ? results : [results];
                const metricsMap = {};

                dataArray.forEach(item => {
                    const unitName = item.unitName || item.UnitName || item.name || item.Name || 'N/A';
                    const values = item.values || item.Values || [];

                    if (Array.isArray(values) && values.length > 0) {
                        values.forEach(v => {
                            if (v && typeof v === 'object') {
                                const year = v.year || v.Year || v.id || v.Id || '';
                                const val = extractValue(v);

                                if (year && val !== null && val !== undefined) {
                                    if (!metricsMap[unitName]) {
                                        metricsMap[unitName] = {};
                                    }
                                    metricsMap[unitName][year] = val;
                                }
                            }
                        });
                    } else if (item.value !== undefined || item.Value !== undefined) {
                        const val = extractValue(item.value || item.Value);
                        const year = item.year || item.Year || item.id || 'N/A';
                        if (val !== null && val !== undefined) {
                            if (!metricsMap[unitName]) {
                                metricsMap[unitName] = {};
                            }
                            metricsMap[unitName][year] = val;
                        }
                    }
                });

                if (Object.keys(metricsMap).length === 0) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>';
                }

                return Object.entries(metricsMap).map(([unitName, years]) => {
                    const yearsList = Object.entries(years)
                        .sort((a, b) => a[0].localeCompare(b[0]))
                        .map(([yr, val]) => {
                            if (val === null || val === undefined) return `${yr}: N/A`;
                            const formattedVal = typeof val === 'number'
                                ? val.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                : String(val);
                            return `${yr}: ${formattedVal}`;
                        })
                        .join(', ');

                    return `
                        <div class="sector-metric">
                            <div class="sector-metric-label">${unitName}</div>
                            <div class="sector-metric-value">${yearsList}</div>
                        </div>
                    `;
                }).join('');
            } else if (type === 'statistics') {
                const stats = data.statistics || data;
                if (!stats || Object.keys(stats).length === 0) {
                    return '<p style="text-align: center; color: var(--text-secondary);">Brak statystyk</p>';
                }

                return Object.entries(stats).map(([key, stat]) => {
                    const variable = stat.variable || {};
                    const varData = stat.data || {};
                    const results = varData.results || varData.data || [];

                    if (Array.isArray(results) && results.length > 0) {
                        let totalValue = 0;
                        let count = 0;
                        results.forEach(item => {
                            const values = item.values || item.Values || [];
                            if (Array.isArray(values)) {
                                values.forEach(v => {
                                    const val = v.value || v.Value;
                                    if (val !== null && val !== undefined) {
                                        try {
                                            totalValue += parseFloat(val);
                                            count++;
                                        } catch (e) { }
                                    }
                                });
                            }
                        });

                        const avgValue = count > 0 ? (totalValue / count).toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A';
                        const varName = variable.name || variable.Name || key;

                        return `
                            <div class="sector-metric">
                                <div class="sector-metric-label">${varName}</div>
                                <div class="sector-metric-value">${avgValue}</div>
                            </div>
                        `;
                    }

                    return `
                        <div class="sector-metric">
                            <div class="sector-metric-label">${translateFieldName(key)}</div>
                            <div class="sector-metric-value">Brak danych</div>
                        </div>
                    `;
                }).join('');
            }

            return '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>';
        }

        document.getElementById('realtimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (loadingStates.realtime) {
                showToast('Proszƒô poczekaƒá na zako≈Ñczenie bie≈ºƒÖcego ≈ºƒÖdania', 'warning');
                return;
            }

            loadingStates.realtime = true;
            setButtonLoading('realtimeFormBtn', true);

            const resultEl = document.getElementById('resultRealtime');
            const errorEl = document.getElementById('errorRealtime');

            resultEl.classList.remove('show');
            hideError('errorRealtime');
            showLoading('loadingRealtime');
            showToast('Pobieranie danych z BDL API...', 'info');

            try {
                const variableId = document.getElementById('realtimeVariableId').value.trim();
                const years = document.getElementById('realtimeYears').value.trim() || '2020,2021,2022,2023,2024,2025';

                if (!variableId) {
                    throw new Error('Proszƒô podaƒá ID zmiennej');
                }

                let url = `/bdl/data/variable/${variableId}`;
                const params = [];
                if (years) params.push(`years=${encodeURIComponent(years)}`);
                if (params.length > 0) url += '?' + params.join('&');

                const data = await fetchData(url);
                const title = `Dane dla zmiennej ${variableId}`;

                hideLoading('loadingRealtime');

                const results = data.results || data.data || [];
                const dataArray = Array.isArray(results) ? results : [results];

                const chartDataMap = new Map();
                const metricsData = {};

                dataArray.forEach(item => {
                    const unitName = item.unitName || item.UnitName || item.name || item.Name || 'N/A';
                    const values = item.values || item.Values || [];

                    if (Array.isArray(values) && values.length > 0) {
                        values.forEach(v => {
                            if (v && typeof v === 'object') {
                                const yearStr = v.year || v.Year || v.id || v.Id || '';
                                const year = parseInt(yearStr);
                                const val = extractValue(v);

                                if (!isNaN(year) && year > 0 && val !== null && val !== undefined && typeof val === 'number') {
                                    if (!chartDataMap.has(year)) {
                                        chartDataMap.set(year, { year: year, value: 0, count: 0 });
                                    }
                                    const dataPoint = chartDataMap.get(year);
                                    dataPoint.value += val;
                                    dataPoint.count += 1;

                                    if (!metricsData[unitName]) {
                                        metricsData[unitName] = { values: [], total: 0, count: 0 };
                                    }
                                    metricsData[unitName].values.push(val);
                                    metricsData[unitName].total += val;
                                    metricsData[unitName].count += 1;
                                }
                            }
                        });
                    }
                });

                const chartData = Array.from(chartDataMap.values());
                chartData.forEach(d => {
                    if (d.count > 0) d.value = d.value / d.count;
                });

                chartData.sort((a, b) => a.year - b.year);

                let historyChart = '<div class="chart-placeholder">Brak danych do wykresu</div>';
                if (chartData.length > 0 && chartData.length > 0) {
                    const chartHistoryData = chartData
                        .filter(d => d.year > 0 && !isNaN(d.year) && d.value > 0)
                        .map(d => ({
                            year: parseInt(d.year),
                            revenue: parseFloat(d.value) || 0,
                            profit: parseFloat(d.value * 0.15) || 0
                        }))
                        .filter(d => d.year > 0);

                    if (chartHistoryData.length > 0) {
                        historyChart = createTrendChart(chartHistoryData, variableId);
                    } else {
                        historyChart = '<div class="chart-placeholder">Brak poprawnych danych do wykresu</div>';
                    }
                }

                let metricsHtml = '';
                if (Object.keys(metricsData).length > 0) {
                    Object.entries(metricsData).slice(0, 5).forEach(([unitName, data]) => {
                        const avgValue = data.count > 0 ? (data.total / data.count) : 0;
                        const formattedValue = typeof avgValue === 'number'
                            ? avgValue.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                            : avgValue;

                        metricsHtml += `
                            <div class="sector-metric">
                                <div class="sector-metric-label">${unitName}</div>
                                <div class="sector-metric-value">${formattedValue}</div>
                            </div>
                        `;
                    });
                } else {
                    metricsHtml = '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>';
                }

                const card = document.createElement('div');
                card.className = 'sector-card';

                card.innerHTML = `
                    <div class="sector-card-header">
                        <div class="sector-card-title">
                            <h3>${title}</h3>
                            <div class="pkd-code">≈πr√≥d≈Ço: BDL GUS</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                Czas: ${new Date().toLocaleString('pl-PL')}
                            </div>
                        </div>
                        <span class="realtime-badge">LIVE</span>
                    </div>
                    <div class="sector-trend-chart">
                        ${historyChart}
                    </div>
                    <div class="sector-card-body">
                        ${metricsHtml}
                    </div>
                `;

                resultEl.innerHTML = '';
                resultEl.appendChild(card);
                resultEl.classList.add('show');
                showToast('Dane za≈Çadowane pomy≈õlnie', 'success');
            } catch (error) {
                hideLoading('loadingRealtime');
                let errorMessage = 'B≈ÇƒÖd pobierania danych';
                if (error.message && error.message.includes('404')) {
                    errorMessage = 'Dane nie znalezione';
                } else if (error.message && error.message.includes('Not Found')) {
                    errorMessage = 'Dane nie znalezione';
                } else if (error.message) {
                    const msg = error.message.toLowerCase();
                    if (msg.includes('404') || msg.includes('not found')) {
                        errorMessage = 'Dane nie znalezione';
                    }
                }
                showError('errorRealtime', errorMessage);
            } finally {
                loadingStates.realtime = false;
                setButtonLoading('realtimeFormBtn', false);
            }
        });

        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        let notes = JSON.parse(localStorage.getItem('notes') || '{}');

        function loadDashboard() {
            const resultEl = document.getElementById('resultDashboard');
            const loadingEl = document.getElementById('loadingDashboard');

            loadingEl.style.display = 'block';
            resultEl.classList.remove('show');

            fetchData('/dashboard').then(data => {
                loadingEl.style.display = 'none';

                const container = document.createElement('div');

                const statsHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${data.total_sectors}</div>
                            <div style="opacity: 0.9;">≈ÅƒÖczna liczba sektor√≥w</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${(data.average_index || 0).toFixed(3)}</div>
                            <div style="opacity: 0.9;">≈öredni indeks</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${data.top_5.length}</div>
                            <div style="opacity: 0.9;">Top sektory</div>
                        </div>
                    </div>
                `;

                const categoryChartId = 'categoryChart_' + Date.now();
                const categoryChart = createCategoryChart(data.category_distribution || {}, categoryChartId);

                const top5Html = data.top_5.map((s, i) => `
                    <div class="sector-metric" style="background: ${i === 0 ? 'linear-gradient(135deg, #667eea20, #764ba220)' : 'transparent'}; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <div class="sector-metric-label">
                            <span style="font-weight: bold; color: var(--primary-color); margin-right: 8px;">#${i + 1}</span>
                            ${s.branch_name || s.pkd_code}
                        </div>
                        <div class="sector-metric-value" style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">
                            ${(s.final_index || 0).toFixed(3)}
                        </div>
                    </div>
                `).join('');

                const bottom5Html = data.bottom_5.map((s, i) => `
                    <div class="sector-metric" style="background: ${i === data.bottom_5.length - 1 ? 'linear-gradient(135deg, #f5576c20, #f093fb20)' : 'transparent'}; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <div class="sector-metric-label">
                            <span style="font-weight: bold; color: #f5576c; margin-right: 8px;">#${data.bottom_5.length - i}</span>
                            ${s.branch_name || s.pkd_code}
                        </div>
                        <div class="sector-metric-value" style="font-size: 1.2em; font-weight: 600; color: #f5576c;">
                            ${(s.final_index || 0).toFixed(3)}
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `
                    ${statsHtml}
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="sector-card">
                            <div class="sector-card-header">
                                <h3 style="margin: 0;">Top 5 sektor√≥w</h3>
                            </div>
                            <div class="sector-card-body">
                                ${top5Html}
                            </div>
                        </div>
                        <div class="sector-card">
                            <div class="sector-card-header">
                                <h3 style="margin: 0;">Bottom 5 sektor√≥w</h3>
                            </div>
                            <div class="sector-card-body">
                                ${bottom5Html}
                            </div>
                        </div>
                    </div>
                    <div class="sector-card">
                        <div class="sector-card-header">
                            <h3 style="margin: 0;">Rozk≈Çad kategorii</h3>
                        </div>
                        <div class="sector-card-body">
                            ${categoryChart}
                        </div>
                    </div>
                `;

                resultEl.innerHTML = '';
                resultEl.appendChild(container);
                resultEl.classList.add('show');

                setTimeout(() => {
                    renderCategoryChart(data.category_distribution || {}, categoryChartId);
                }, 100);
            }).catch(error => {
                loadingEl.style.display = 'none';
                showError('errorDashboard', `B≈ÇƒÖd: ${error.message}`);
            });
        }

        function createCategoryChart(distribution, chartId) {
            return `
                <canvas id="${chartId}" width="600" height="300" style="max-width: 100%; height: auto;"></canvas>
            `;
        }

        function renderCategoryChart(distribution, chartId) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const categories = Object.keys(distribution);
            const values = Object.values(distribution);
            const total = values.reduce((a, b) => a + b, 0);

            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe', '#f5576c'];
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) / 2 - 40;

            let currentAngle = -Math.PI / 2;

            values.forEach((value, index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--card-bg') || '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();

                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);

                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(value, labelX, labelY);

                currentAngle += sliceAngle;
            });

            const legendY = 20;
            categories.forEach((cat, idx) => {
                const legendX = 20;
                const legendItemY = legendY + idx * 25;

                ctx.fillStyle = colors[idx % colors.length];
                ctx.fillRect(legendX, legendItemY, 15, 15);

                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color') || '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${cat} (${values[idx]})`, legendX + 20, legendItemY + 12);
            });
        }

        document.getElementById('advancedSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const query = document.getElementById('searchQuery').value.trim();
            const minIndex = document.getElementById('minIndex').value;
            const maxIndex = document.getElementById('maxIndex').value;
            const minGrowth = document.getElementById('minGrowth').value;
            const maxGrowth = document.getElementById('maxGrowth').value;
            const categories = document.getElementById('searchCategories').value.trim();

            const params = [];
            if (query) params.push(`query=${encodeURIComponent(query)}`);
            if (minIndex) params.push(`min_index=${minIndex}`);
            if (maxIndex) params.push(`max_index=${maxIndex}`);
            if (minGrowth) params.push(`min_growth=${minGrowth}`);
            if (maxGrowth) params.push(`max_growth=${maxGrowth}`);
            if (categories) params.push(`categories=${encodeURIComponent(categories)}`);

            const resultEl = document.getElementById('resultAdvancedSearch');
            const loadingEl = document.getElementById('loadingAdvancedSearch');

            resultEl.classList.remove('show');
            loadingEl.style.display = 'block';

            try {
                const data = await fetchData(`/sectors/search?${params.join('&')}`);
                loadingEl.style.display = 'none';
                await showSectorsGrid('resultAdvancedSearch', data);
                showToast(`Znaleziono ${data.length} sektor√≥w`, 'success');
            } catch (error) {
                loadingEl.style.display = 'none';
                showError('errorAdvancedSearch', `B≈ÇƒÖd: ${error.message}`);
            }
        });

        document.getElementById('compareForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const pkd1 = document.getElementById('comparePkd1').value.trim();
            const pkd2 = document.getElementById('comparePkd2').value.trim();
            const pkd3 = document.getElementById('comparePkd3').value.trim();

            if (!pkd1) {
                showError('errorCompare', 'Wybierz przynajmniej jeden sektor');
                return;
            }

            const compareList = [pkd1];
            if (pkd2) compareList.push(pkd2);
            if (pkd3) compareList.push(pkd3);

            const resultEl = document.getElementById('resultCompare');
            const loadingEl = document.getElementById('loadingCompare');

            resultEl.classList.remove('show');
            loadingEl.style.display = 'block';

            try {
                const data = await fetchData(`/sector/${pkd1}/compare?compare_with=${compareList.slice(1).join(',')}`);
                loadingEl.style.display = 'none';

                const comparisonTable = createComparisonTable(data);

                const container = document.createElement('div');
                container.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--text-color); margin-bottom: 15px; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            Por√≥wnawcza tabela
                        </h3>
                        ${comparisonTable}
                    </div>
                    <div style="margin-bottom: 30px;" id="compareChartsContainer">
                        <h3 style="color: var(--text-color); margin-bottom: 15px; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            Wykresy por√≥wnawcze
                        </h3>
                        <div id="compareCharts"></div>
                    </div>
                    <div>
                        <h3 style="color: var(--text-color); margin-bottom: 15px; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            Szczeg√≥≈Çy sektor√≥w
                        </h3>
                        <div class="sectors-grid" id="compareSectorsGrid"></div>
                    </div>
                `;

                resultEl.innerHTML = '';
                resultEl.appendChild(container);
                resultEl.classList.add('show');

                setTimeout(() => {
                    const chartsContainer = document.getElementById('compareCharts');
                    if (chartsContainer) {
                        chartsContainer.innerHTML = createComparisonCharts(data);
                    }
                }, 100);

                const gridEl = document.getElementById('compareSectorsGrid');
                for (const sector of data) {
                    const card = await createSectorCard(sector, false);
                    gridEl.appendChild(card);
                }

                showToast('Sektory por√≥wnane pomy≈õlnie', 'success');
            } catch (error) {
                loadingEl.style.display = 'none';
                showError('errorCompare', `B≈ÇƒÖd: ${error.message}`);
            }
        });

        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const pkd = document.getElementById('predictionPkd').value.trim();
            if (!pkd) {
                showError('errorPrediction', 'Wybierz kod PKD');
                return;
            }

            const resultEl = document.getElementById('resultPrediction');
            const loadingEl = document.getElementById('loadingPrediction');

            resultEl.classList.remove('show');
            loadingEl.style.display = 'block';

            try {
                const data = await fetchData(`/sector/${pkd}/predict`);
                loadingEl.style.display = 'none';

                const card = document.createElement('div');
                card.className = 'sector-card';

                let predictionHtml = '';
                if (data.prediction) {
                    predictionHtml = Object.entries(data.prediction).filter(([k]) => k !== 'year' && k !== 'predicted').map(([key, value]) => `
                        <div class="sector-metric">
                            <div class="sector-metric-label">${translateFieldName(key)}</div>
                            <div class="sector-metric-value">${typeof value === 'number' ? value.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " z≈Ç" : value}</div>
                        </div>
                    `).join('');
                }

                card.innerHTML = `
                    <div class="sector-card-header">
                        <div class="sector-card-title">
                            <h3>Prognoza dla PKD ${pkd}</h3>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                Trend: ${data.trend_indicator || '‚Üí'} | Rok: ${data.prediction?.year || 'N/A'}
                            </div>
                        </div>
                    </div>
                    <div class="sector-card-body">
                        ${predictionHtml || '<p style="text-align: center; color: var(--text-secondary);">Brak prognozy</p>'}
                    </div>
                `;

                resultEl.innerHTML = '';
                resultEl.appendChild(card);
                resultEl.classList.add('show');
                showToast('Prognoza za≈Çadowana', 'success');
            } catch (error) {
                loadingEl.style.display = 'none';
                showError('errorPrediction', `B≈ÇƒÖd: ${error.message}`);
            }
        });

        document.getElementById('recommendationsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const pkd = document.getElementById('recommendationsPkd').value.trim();
            if (!pkd) {
                showError('errorRecommendations', 'Wybierz kod PKD');
                return;
            }

            const resultEl = document.getElementById('resultRecommendations');
            const loadingEl = document.getElementById('loadingRecommendations');

            resultEl.classList.remove('show');
            loadingEl.style.display = 'block';

            try {
                const data = await fetchData(`/sector/${pkd}/recommendations?limit=5`);
                loadingEl.style.display = 'none';
                await showSectorsGrid('resultRecommendations', data.recommendations);
                showToast(`Znaleziono ${data.recommendations.length} podobnych sektor√≥w`, 'success');
            } catch (error) {
                loadingEl.style.display = 'none';
                showError('errorRecommendations', `B≈ÇƒÖd: ${error.message}`);
            }
        });

        document.getElementById('periodCompareForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const pkd = document.getElementById('periodPkd').value.trim();
            const period1Start = document.getElementById('period1Start').value;
            const period1End = document.getElementById('period1End').value;
            const period2Start = document.getElementById('period2Start').value;
            const period2End = document.getElementById('period2End').value;

            if (!pkd || !period1Start || !period1End || !period2Start || !period2End) {
                showError('errorPeriodCompare', 'Wype≈Çnij wszystkie pola');
                return;
            }

            const resultEl = document.getElementById('resultPeriodCompare');
            const loadingEl = document.getElementById('loadingPeriodCompare');

            resultEl.classList.remove('show');
            loadingEl.style.display = 'block';

            try {
                const data = await fetchData(`/sector/${pkd}/history/compare?period1=${period1Start}-${period1End}&period2=${period2Start}-${period2End}`);
                loadingEl.style.display = 'none';

                const card = document.createElement('div');
                card.className = 'sector-card';

                const changesHtml = Object.entries(data.changes || {}).map(([key, value]) => `
                    <div class="sector-metric">
                        <div class="sector-metric-label">${translateFieldName(key)}</div>
                        <div class="sector-metric-value">${typeof value === 'number' ? (value > 0 ? '+' : '') + value.toFixed(2) + '%' : value}</div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="sector-card-header">
                        <div class="sector-card-title">
                            <h3>Por√≥wnanie okres√≥w</h3>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                ${data.period1.range} vs ${data.period2.range}
                            </div>
                        </div>
                    </div>
                    <div class="sector-card-body">
                        <h4>Zmiany (%)</h4>
                        ${changesHtml || '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>'}
                    </div>
                `;

                resultEl.innerHTML = '';
                resultEl.appendChild(card);
                resultEl.classList.add('show');
                showToast('Okresy por√≥wnane pomy≈õlnie', 'success');
            } catch (error) {
                loadingEl.style.display = 'none';
                showError('errorPeriodCompare', `B≈ÇƒÖd: ${error.message}`);
            }
        });

        function loadCorrelations() {
            const resultEl = document.getElementById('resultCorrelations');
            const loadingEl = document.getElementById('loadingCorrelations');

            loadingEl.style.display = 'block';
            resultEl.classList.remove('show');

            fetchData('/analytics/correlations').then(data => {
                loadingEl.style.display = 'none';

                const card = document.createElement('div');
                card.className = 'sector-card';

                const correlationsHtml = Object.entries(data.correlations || {}).map(([key, value]) => `
                    <div class="sector-metric">
                        <div class="sector-metric-label">${translateFieldName(key)}</div>
                        <div class="sector-metric-value">${typeof value === 'number' ? value.toFixed(3) : value}</div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="sector-card-header">
                        <div class="sector-card-title">
                            <h3>Korelacje z indeksem ko≈Ñcowym</h3>
                        </div>
                    </div>
                    <div class="sector-card-body">
                        ${correlationsHtml || '<p style="text-align: center; color: var(--text-secondary);">Brak danych</p>'}
                    </div>
                `;

                resultEl.innerHTML = '';
                resultEl.appendChild(card);
                resultEl.classList.add('show');
            }).catch(error => {
                loadingEl.style.display = 'none';
                showError('errorCorrelations', `B≈ÇƒÖd: ${error.message}`);
            });
        }

        function addFavorite() {
            const pkd = document.getElementById('favoritePkd').value.trim();
            if (!pkd) {
                showToast('Wybierz kod PKD', 'warning');
                return;
            }

            if (!favorites.includes(pkd)) {
                favorites.push(pkd);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavoritesList();
                showToast('Dodano do ulubionych', 'success');
            } else {
                showToast('Sektor ju≈º jest w ulubionych', 'warning');
            }
        }

        function removeFavorite(pkd) {
            favorites = favorites.filter(f => f !== pkd);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoritesList();
            showToast('Usuniƒôto z ulubionych', 'success');
        }

        function updateFavoritesList() {
            const listEl = document.getElementById('favoritesList');
            if (!listEl) return;
            if (favorites.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 10px;">Brak ulubionych sektor√≥w</p>';
                return;
            }

            listEl.innerHTML = favorites.map(pkd => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--card-bg); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                    <span style="font-weight: 600;">${pkd}</span>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="loadSectorQuick('${pkd}')" style="background: var(--primary-color); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em;">Poka≈º</button>
                        <button onclick="removeFavorite('${pkd}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em;">Usu≈Ñ</button>
                    </div>
                </div>
            `).join('');
        }

        async function showFavoritesQuick() {
            if (favorites.length === 0) {
                showToast('Brak ulubionych sektor√≥w', 'info');
                return;
            }

            const resultEl = document.getElementById('result');
            const loadingEl = document.getElementById('loading');

            loadingEl.style.display = 'block';
            resultEl.classList.remove('show');

            try {
                const sectors = [];
                for (const pkd of favorites) {
                    try {
                        const sector = await fetchData(`/sector/${pkd}`);
                        sectors.push(sector);
                    } catch (e) {
                        console.error(`B≈ÇƒÖd ≈Çadowania sektora ${pkd}:`, e);
                    }
                }

                loadingEl.style.display = 'none';
                await showSectorsGrid('result', sectors);
                resultEl.classList.add('show');
                showToast(`Za≈Çadowano ${sectors.length} ulubionych sektor√≥w`, 'success');
            } catch (error) {
                loadingEl.style.display = 'none';
                showError('error', `B≈ÇƒÖd: ${error.message}`);
            }
        }

        async function loadSectorQuick(pkd) {
            const resultEl = document.getElementById('result');
            const loadingEl = document.getElementById('loading');

            loadingEl.style.display = 'block';
            resultEl.classList.remove('show');

            try {
                const sector = await fetchData(`/sector/${pkd}`);
                loadingEl.style.display = 'none';
                await showSectorCard('result', sector);
                resultEl.classList.add('show');
                showToast('Sektor za≈Çadowany', 'success');
            } catch (error) {
                loadingEl.style.display = 'none';
                showError('error', `B≈ÇƒÖd: ${error.message}`);
            }
        }

        function saveNote() {
            const pkd = document.getElementById('notePkd').value.trim();
            const noteText = document.getElementById('noteText').value.trim();

            if (!pkd) {
                showToast('Wybierz kod PKD', 'warning');
                return;
            }

            if (!noteText) {
                showToast('Wpisz notatkƒô', 'warning');
                return;
            }

            notes[pkd] = {
                text: noteText,
                date: new Date().toISOString()
            };
            localStorage.setItem('notes', JSON.stringify(notes));
            updateNotesList();
            document.getElementById('noteText').value = '';
            showToast('Notatka zapisana', 'success');
        }

        function updateNotesList() {
            const listEl = document.getElementById('notesList');
            const noteEntries = Object.entries(notes);

            if (noteEntries.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-secondary);">Brak notatek</p>';
                return;
            }

            listEl.innerHTML = noteEntries.map(([pkd, note]) => `
                <div style="padding: 15px; background: var(--bg-color); border-radius: 5px; margin-bottom: 10px; border-left: 4px solid var(--primary-color);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>PKD ${pkd}</strong>
                        <button onclick="deleteNote('${pkd}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">Usu≈Ñ</button>
                    </div>
                    <p style="color: var(--text-color); margin: 5px 0;">${note.text}</p>
                    <small style="color: var(--text-secondary);">${new Date(note.date).toLocaleString('pl-PL')}</small>
                </div>
            `).join('');
        }

        function deleteNote(pkd) {
            delete notes[pkd];
            localStorage.setItem('notes', JSON.stringify(notes));
            updateNotesList();
            showToast('Notatka usuniƒôta', 'success');
        }

        function exportSectorData(pkd, format) {
            window.open(`/sector/${pkd}/export?format=${format}`, '_blank');
        }

        function populateSelects() {
            fetchData('/available-pkd').then(data => {
                const selects = ['pkdCode', 'comparePkd1', 'comparePkd2', 'comparePkd3',
                    'predictionPkd', 'recommendationsPkd', 'periodPkd',
                    'favoritePkd', 'notePkd'];

                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Wybierz kod PKD...</option>';
                        data.sectors.forEach(sector => {
                            const option = document.createElement('option');
                            option.value = sector.pkd_code;
                            option.textContent = `${sector.pkd_code} - ${sector.branch_name || 'N/A'}`;
                            select.appendChild(option);
                        });
                        if (currentValue) {
                            select.value = currentValue;
                        }
                    }
                });
            }).catch(error => {
                logger.error(`B≈ÇƒÖd ≈Çadowania PKD: ${error.message}`);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateSelects();
            updateFavoritesList();
            updateNotesList();
        });
    </script>
</body>

</html>